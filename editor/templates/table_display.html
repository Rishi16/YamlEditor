<!DOCTYPE html>
<html>
<head>
    <title>Table Display</title>
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 0;
            margin: 0;
        }
        .container-fluid {
            background-color: #fff;
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
            height: 100vh;
        }
        h1 {
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
        .table {
            margin-bottom: 20px;
        }
        th {
            font-weight: bold;
        }
        .editable {
            cursor: pointer;
            text-decoration: underline;
        }
    .list-modal {
        background-color: #fff;
        padding: 20px;
        border-radius: 4px;
        box-shadow: 0 0 8px rgba(0,0,0,0.1);
        max-width: 800px; /* Set the maximum width for the popup box */
        margin: 0 auto; /* Center the popup box horizontally */
    }

        .list-modal .list-group {
            margin-bottom: 20px;
        }
        .list-modal .btn {
            margin-right: 5px;
        }

    .list-modal .form-group {
        align-items: center;
        margin-bottom: 10px;
    }

    .list-modal .form-group .form-control {
        flex-grow: 1;
        margin-right: 5px;
    }
    .list-modal .form-group:last-child .btn-danger {
        margin-top: 0;
    }
        .list-modal .form-group input {
            width: 90%;
            padding: 5px;
            font-size: inherit;
        }

    </style>
</head>
<body>
<div class="container-fluid">
    <h1>Table Display</h1>
    <table id="dataTable" class="table table-striped table-bordered">
        <thead>
        <tr>
            <th>Product</th>
            <th>Type</th>
            <th>Target Observable Type</th>
            <th>Name</th>
            <th>Strong</th>
            <th>Weak</th>
            <th>Target Extra Prop</th>
            <th>Extra Prop</th>
            <th>Target Related Extra Prop</th>
            <th>Related Extra Prop</th>
        </tr>
        </thead>
        <tbody>
        {% for config in configs %}
        <tr id="row-{{ config.id }}">
            <td class="editable" onclick="editCell(this, 'product', {{ config.id }})" id="row-{{ config.id }}-product">{{ config.product }}</td>
            <td class="editable" onclick="editCell(this, 'type', {{ config.id }})" id="row-{{ config.id }}-type">{{ config.type }}</td>
            <td class="editable" onclick="editCell(this, 'target_observable_type', {{ config.id }})" id="row-{{ config.id }}-target_observable_type">{{ config.target_observable_type }}</td>
            <td class="editable" onclick="editCell(this, 'name', {{ config.id }})" id="row-{{ config.id }}-name">{{ config.name }}</td>
            <td class="editable" onclick="editCell(this, 'strong', {{ config.id }})" id="row-{{ config.id }}-strong">{{ config.strong }}</td>
            <td class="editable" onclick="editCell(this, 'weak', {{ config.id }})" id="row-{{ config.id }}-weak">{{ config.weak }}</td>
            <td class="editable" onclick="editCell(this, 'target_extra_prop', {{ config.id }})" id="row-{{ config.id }}-target_extra_prop">{{ config.target_extra_prop }}</td>
            <td class="editable" onclick="editCell(this, 'extra_prop', {{ config.id }})" id="row-{{ config.id }}-extra_prop">{{ config.extra_prop }}</td>
            <td class="editable" onclick="editCell(this, 'target_related_extra_prop', {{ config.id }})" id="row-{{ config.id }}-target_related_extra_prop">{{ config.target_related_extra_prop }}</td>
            <td class="editable" onclick="editCell(this, 'related_extra_prop', {{ config.id }})" id="row-{{ config.id }}-related_extra_prop">{{ config.related_extra_prop }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- String Field Modal -->
<div class="modal fade" id="stringFieldModal" tabindex="-1" role="dialog" aria-labelledby="stringFieldModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content list-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="stringFieldModalLabel">Edit Value</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" id="stringFieldGroup">
                    <input type="text" class="form-control" id="stringFieldValue">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="saveStringField()">Done</button>
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- List Field Modal -->
<div class="modal fade" id="listFieldModal" tabindex="-1" role="dialog" aria-labelledby="listFieldModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content list-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="listFieldModalLabel">List Items</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group" id="listFieldGroup">
                    <div id="listItems">
                        <!-- Populated dynamically with list items -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="addButton" onclick="addItem('listItems')">Add</button>
                <button class="btn btn-success" onclick="saveListField()">Done</button>
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap4.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script>
    let targetField;
    let listItems = [];

    function editCell(cell, field, id) {
        console.log(`Calling editCell function with cell:`, cell, `field:`, field, `and id:`, id);
        targetField = field;
        const oldValue = cell.innerText;
        listItems = [];

        // Parse list items for list fields only
        if (
            targetField === 'extra_prop' ||
            targetField === 'related_extra_prop' ||
            targetField === 'strong' ||
            targetField === 'weak' ||
            targetField === 'target_extra_prop' ||
            targetField === 'target_related_extra_prop'
        ) {
            console.log(`Parsing list items for field:`, targetField, `with oldValue:`, oldValue);
            listItems = parseListItems(oldValue);
        }

        populateList('listItems', listItems, targetField, oldValue);

        // Get the corresponding column name for the label
        let columnName = getColumnName(cell.cellIndex);
        console.log(`Column header for cellIndex ${cell.cellIndex}:`, columnName);

        if (
            targetField === 'extra_prop' ||
            targetField === 'related_extra_prop' ||
            targetField === 'strong' ||
            targetField === 'weak' ||
            targetField === 'target_extra_prop' ||
            targetField === 'target_related_extra_prop'
        ) {
            $('#listFieldModalLabel').text(columnName);
            $('#listFieldModal').modal('show');
        } else {
            $('#stringFieldModalLabel').text(columnName);
            $('#stringFieldValue').val(oldValue);
            $('#stringFieldModal').modal('show');
        }
    }

    function getColumnName(cellIndex) {

        console.log(`Calling getColumnName function with cellIndex:`, cellIndex);
        const tableHeader = document.querySelector('.table thead tr');
        const columnHeader = tableHeader.cells[cellIndex];
        return columnHeader.textContent.trim();
    }

    function parseListItems(value) {
        console.log(`Calling parseListItems function with value:`, value);
        // Remove leading and trailing brackets [ ]
        value = value.trim().slice(1, -1);

        // Split by comma and remove leading and trailing spaces and quotes
        const items = value.split(',').map(item => item.trim().replace(/^['"]|['"]$/g, ''));

        return items;
    }

    function joinListItems(items) {
        console.log(`Calling joinListItems function with items:`, items);
        // Join items with comma and space
        const value = items.join(', ');

        // Add leading and trailing brackets [ ]
        return `[${value}]`;
    }

    function populateList(containerId, items, field, value) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        // If field is of string type, display a single input without "Add" button
        if (field === 'product' || field === 'type' || field === 'name' || field === 'target_observable_type') {
            const listItem = document.createElement('div');
            listItem.className = 'form-group';
            listItem.innerHTML = `
                <input type="text" class="form-control" value="${value}">
            `;
            container.appendChild(listItem);
        } else {
            // For list types, display inputs with "Add" button
            for (let i = 0; i < items.length; i++) {
                const listItem = document.createElement('div');
                listItem.className = 'form-group';
                if (
                    targetField === 'extra_prop' ||
                    targetField === 'related_extra_prop' ||
                    targetField === 'strong' ||
                    targetField === 'weak'
                ) {
                    listItem.innerHTML = `
                        <div class="input-group">
                            <input type="text" class="form-control" value="${items[i]}">
                            <div class="input-group-append">
                                <button class="btn btn-danger btn-sm" onclick="removeItem(this)"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    `;
                } else {
                    listItem.innerHTML = `
                        <input type="text" class="form-control" value="${items[i]}">
                    `;
                }
                container.appendChild(listItem);
            }
            // Show the "Add" button only for list types
            const addButton = document.getElementById('addButton');
            addButton.style.display = (
                targetField === 'extra_prop' ||
                targetField === 'related_extra_prop' ||
                targetField === 'strong' ||
                targetField === 'weak'
            ) ? 'block' : 'none';
        }
    }

    function addItem(containerId) {
        console.log(`Calling addItem function with containerId:`, containerId);
        const container = document.getElementById(containerId);
        const listItem = document.createElement('div');
        listItem.className = 'form-group';
        listItem.innerHTML = `
            <div class="input-group">
                <input type="text" class="form-control" value="">
                <div class="input-group-append">
                    <button class="btn btn-danger btn-sm" onclick="removeItem(this)"><i class="fas fa-minus"></i></button>
                </div>
            </div>
        `;
        container.appendChild(listItem);
    }

    function removeItem(button) {
        console.log(`Calling removeItem function`);
        const listItem = button.parentNode.parentNode;
        listItem.parentNode.removeChild(listItem);
    }

    function removeItems(containerId) {
        console.log(`Calling removeItems function with containerId:`, containerId);
        const container = document.getElementById(containerId);
        const items = container.getElementsByClassName('list-item');
        removeListItems(items);
    }

    function removeListItems(items) {
        console.log(`Calling removeListItems function`);
        for (let i = items.length - 1; i >= 0; i--) {
            items[i].parentNode.removeChild(items[i]);
        }
    }

    function saveStringField() {
        console.log(`Calling saveStringField function`);
        const cell = document.querySelector('.editable.active');
        const newValue = document.getElementById('stringFieldValue').value;
        cell.innerText = newValue;
        $('#stringFieldModal').modal('hide');
    }

    function saveListField() {
        console.log(`Calling saveListField function`);
        const cell = document.querySelector('.editable.active');
        const container = document.getElementById('listItems');
        const items = container.getElementsByClassName('form-control');
        const values = [];
        for (let i = 0; i < items.length; i++) {
            values.push(items[i].value);
        }
        const newValue = joinListItems(values);
        cell.innerText = newValue;
        $('#listFieldModal').modal('hide');
    }

    $(document).ready(function () {
        // Initialize DataTables
        $('#dataTable').DataTable({
            // Define the columns and their initial sorting order (e.g., ascending or descending)
            columnDefs: [
                { targets: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], orderable: true },
                { targets: '_all', orderable: false } // Disable sorting for the last column (id)
            ],
            // Enable filtering
            searching: true,
        });
    });
</script>
</body>
</html>